<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <title>User Profile</title>
    <link rel="stylesheet" th:href="@{/css/styles.css}">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://unpkg.com/cropperjs@1.5.13/dist/cropper.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/cropperjs@1.5.13/dist/cropper.min.css"/>

</head>
<body th:replace="~{layout :: bodyContent}">
<div th:fragment="content">
    <div class="profile-wrapper">
        <div class="profile-header">
            <div class="profile-info">
                <label for="profilePictureFile" class="profile-picture-label">
                    <img class="avatar profile-picture"
                         th:src="${user.currentPerson?.profilePicture != null} ? @{/profilePicture/{id}(id=${user.id})} : '/images/default-profile.png'"
                         alt="Profile Picture"
                         id="avatarPreview">
                    <div class="upload-icon"></div>
                </label>
                <div class="profile-meta">
                    <h2 th:text="${user.login}" style="text-align: start">Login</h2>
                    <p th:text="${user.currentPerson?.email}">email@example.com</p>
                </div>
            </div>
            <button type="button" class="edit-button" id="editBtn">Edit</button>
        </div>

        <form th:action="@{/updateProfile}" method="post" enctype="multipart/form-data" class="profile-grid"
              id="profileForm">
            <input type="file" name="profilePictureFile" id="profilePictureFile" style="display: none;"
                   accept="image/*">
            <div class="profile-group">
                <label>Full Name</label>
                <input type="text" name="fullName" th:value="${user.currentPerson?.getFullName()}" disabled>
            </div>
            <div class="profile-group">
                <label>Nick Name</label>
                <input type="text" name="username" th:value="${user.username}" disabled>
            </div>
            <div class="profile-group">
                <label>Gender</label>
                <select name="sex.id" disabled>
                    <option th:each="s : ${sexes}"
                            th:value="${s.id}"
                            th:text="${s.getLangValue(user.getLang())}"
                            th:selected="${user.currentPerson?.sex?.id == s.id}">Gender
                    </option>
                </select>
            </div>
            <div class="profile-group">
                <label>Country</label>
                <select name="country" disabled>
                    <option th:each="c : ${countries}"
                            th:value="${c}"
                            th:text="${c}"
                            th:selected="${user.currentPerson?.country == c}">
                    </option>
                </select>
            </div>
            <div class="profile-group">
                <label>Language</label>
                <select name="language" disabled>
                    <option th:selected="${user.lang == 0}">Русский</option>
                    <option th:selected="${user.lang == 1}">English</option>
                </select>
            </div>
            <div class="profile-group">
                <label>Time Zone</label>
                <select name="timezone" disabled>
                    <option>UTC+5</option>
                    <option>UTC+6</option>
                </select>
            </div>
            <div class="profile-group full-width">
                <label>Email</label>
                <input type="email" name="email" th:value="${user.currentPerson?.email}" disabled>
            </div>
            <div class="profile-actions full-width">
                <button type="submit" id="saveBtn" style="display: none;">Save</button>
            </div>
        </form>
    </div>
    <div class="modal" id="cropperModal">
        <div class="modal-content" style="padding-bottom: 70px; position: relative;">
            <span class="close" onclick="closeCropperModal()">&times;</span>
            <h2 style="text-align: center;">Редактировать изображение</h2>

            <div class="cropper-wrapper" style="position: relative; width: 100%; max-width: 400px; margin: 0 auto;">
                <div class="cropper-mask"></div>
                <img id="cropperImage" style="max-width: 100%; display: block;">
            </div>

            <div style="margin-top: var(--spacing-md); text-align: center;">
                <label for="zoomRange" style="color: var(--text-secondary); margin-right: 10px;">Масштаб</label>
                <input type="range" id="zoomRange" min="0.1" max="3" step="0.01" value="1">
            </div>

            <div style="text-align: center; margin-top: 20px;">
                <button onclick="applyCrop()">Отправить</button>
            </div>
        </div>
    </div>

</div>
</body>
<script>
    const editBtn = document.getElementById('editBtn');
    const form = document.getElementById('profileForm');
    const inputs = form.querySelectorAll('input, select');
    const saveBtn = document.getElementById('saveBtn');

    let editing = false;
    const originalValues = {};

    // Сохраняем начальные значения
    inputs.forEach(el => {
        if (el.name) {
            originalValues[el.name] = el.value;
        }
    });

    editBtn.addEventListener('click', function () {
        editing = !editing;

        if (editing) {
            // Включаем редактирование
            inputs.forEach(el => el.disabled = false);
            saveBtn.style.display = 'inline-block';
            editBtn.textContent = 'Cancel';
        } else {
            // Откатываем изменения
            inputs.forEach(el => {
                if (el.name && originalValues[el.name] !== undefined) {
                    el.value = originalValues[el.name];
                }
                el.disabled = true;
            });
            saveBtn.style.display = 'none';
            editBtn.textContent = 'Edit';
        }
    });
</script>
<script>
    const fileInput = document.getElementById('profilePictureFile');
    const avatarPreview = document.getElementById('avatarPreview');
    const cropperModal = document.getElementById('cropperModal');
    const cropperImage = document.getElementById('cropperImage');

    let cropper;

    fileInput.addEventListener('change', function () {
        const file = this.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function (e) {
                cropperImage.src = e.target.result;
                cropperModal.style.display = 'block';

                cropperImage.onload = () => {
                    if (cropper) cropper.destroy();
                    cropper = new Cropper(cropperImage, {
                        viewMode: 1,
                        background: false,
                        zoomable: true,
                        movable: true,
                        dragMode: 'move',

                        /* квадрат 1:1, весь автокроп, но без ручек */
                        aspectRatio: 1,
                        autoCrop: true,
                        autoCropArea: 1,
                        cropBoxMovable: false,
                        cropBoxResizable: false,
                        minCropBoxWidth: 300,
                        minCropBoxHeight: 300,

                        responsive: true,

                        ready() {
                            // центрируем crop-box под твоей маской 300×300
                            const container = cropper.getContainerData();
                            cropper.setCropBoxData({
                                left: (container.width - 300) / 2,
                                top: (container.height - 300) / 2,
                                width: 300,
                                height: 300
                            });
                        }
                    });
                };
            };
            reader.readAsDataURL(file);
        }
    });

    document.getElementById("zoomRange").addEventListener("input", function () {
        if (cropper) {
            cropper.zoomTo(parseFloat(this.value));
        }
    });


    function applyCrop() {
        // Берём квадрат из cropper — он уже отскейлен и выровнен
        const squareCanvas = cropper.getCroppedCanvas({
            width: 300,
            height: 300,
            imageSmoothingEnabled: true,
            imageSmoothingQuality: 'high'
        });

        // Создаём круглый canvas
        const circleCanvas = document.createElement('canvas');
        const ctx = circleCanvas.getContext('2d');
        const size = 300;

        circleCanvas.width = size;
        circleCanvas.height = size;

        // Делаем круглую область
        ctx.beginPath();
        ctx.arc(size / 2, size / 2, size / 2, 0, Math.PI * 2);
        ctx.closePath();
        ctx.clip();

        // Рисуем квадрат внутри круга
        ctx.drawImage(squareCanvas, 0, 0, size, size);

        // Показываем preview
        avatarPreview.src = circleCanvas.toDataURL();

        // Загружаем в input
        circleCanvas.toBlob(blob => {
            const croppedFile = new File([blob], "avatar.png", {type: "image/png"});
            const dt = new DataTransfer();
            dt.items.add(croppedFile);
            fileInput.files = dt.files;

            cropperModal.style.display = 'none';
            cropper.destroy();
        });
    }


    function closeCropperModal() {
        cropperModal.style.display = 'none';
        if (cropper) cropper.destroy();
    }

</script>
</html>
